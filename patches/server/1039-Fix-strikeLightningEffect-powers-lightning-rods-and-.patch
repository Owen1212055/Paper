From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Tamion <70228790+notTamion@users.noreply.github.com>
Date: Sat, 30 Sep 2023 12:36:14 +0200
Subject: [PATCH] Fix strikeLightningEffect powers lightning rods and clears
 copper


diff --git a/src/main/java/net/minecraft/server/level/ServerLevel.java b/src/main/java/net/minecraft/server/level/ServerLevel.java
index 17610196db7a1c6feb2cf74a02479a8691aa323f..ef7a721df01723cc64c2ddffa536cd842997282b 100644
--- a/src/main/java/net/minecraft/server/level/ServerLevel.java
+++ b/src/main/java/net/minecraft/server/level/ServerLevel.java
@@ -997,7 +997,7 @@ public class ServerLevel extends Level implements WorldGenLevel {
 
                 if (entitylightning != null) {
                     entitylightning.moveTo(Vec3.atBottomCenterOf(blockposition));
-                    entitylightning.setVisualOnly(flag1);
+                    entitylightning.skeletonTrap = flag1; // Paper
                     this.strikeLightning(entitylightning, org.bukkit.event.weather.LightningStrikeEvent.Cause.WEATHER); // CraftBukkit
                 }
             }
diff --git a/src/main/java/net/minecraft/world/entity/LightningBolt.java b/src/main/java/net/minecraft/world/entity/LightningBolt.java
index 471275c5362b61ce8b5b9dd5c85b3e93cabd3f76..829778169b74e1543d034fd3294ce39151f48800 100644
--- a/src/main/java/net/minecraft/world/entity/LightningBolt.java
+++ b/src/main/java/net/minecraft/world/entity/LightningBolt.java
@@ -46,6 +46,7 @@ public class LightningBolt extends Entity {
     private final Set<Entity> hitEntities = Sets.newHashSet();
     private int blocksSetOnFire;
     public boolean isSilent = false; // Spigot
+    public boolean skeletonTrap; // Paper
 
     public LightningBolt(EntityType<? extends LightningBolt> type, Level world) {
         super(type, world);
@@ -86,7 +87,7 @@ public class LightningBolt extends Entity {
     @Override
     public void tick() {
         super.tick();
-        if (!this.isSilent && this.life == 2) { // Spigot
+        if (!this.visualOnly && !this.isSilent && this.life == 2) { // Spigot // Paper
             if (this.level().isClientSide()) {
                 this.level().playLocalSound(this.getX(), this.getY(), this.getZ(), SoundEvents.LIGHTNING_BOLT_THUNDER, SoundSource.WEATHER, 10000.0F, 0.8F + this.random.nextFloat() * 0.2F, false);
                 this.level().playLocalSound(this.getX(), this.getY(), this.getZ(), SoundEvents.LIGHTNING_BOLT_IMPACT, SoundSource.WEATHER, 2.0F, 0.5F + this.random.nextFloat() * 0.2F, false);
@@ -133,7 +134,7 @@ public class LightningBolt extends Entity {
             }
         }
 
-        if (this.life >= 0 && !this.visualOnly) { // CraftBukkit - add !this.visualOnly
+        if (this.life >= 0 && !this.visualOnly && !this.skeletonTrap) { // CraftBukkit - add !this.visualOnly // Paper
             if (!(this.level() instanceof ServerLevel)) {
                 this.level().setSkyFlashTime(2);
             } else if (!this.visualOnly) {
@@ -162,7 +163,7 @@ public class LightningBolt extends Entity {
     }
 
     private void spawnFire(int spreadAttempts) {
-        if (!this.visualOnly && !this.level().isClientSide && this.level().getGameRules().getBoolean(GameRules.RULE_DOFIRETICK)) {
+        if (!this.visualOnly && !this.skeletonTrap && !this.level().isClientSide && this.level().getGameRules().getBoolean(GameRules.RULE_DOFIRETICK)) { // Paper
             BlockPos blockposition = this.blockPosition();
             BlockState iblockdata = BaseFireBlock.getState(this.level(), blockposition);
 
diff --git a/src/main/java/net/minecraft/world/entity/animal/horse/SkeletonTrapGoal.java b/src/main/java/net/minecraft/world/entity/animal/horse/SkeletonTrapGoal.java
index d00fb16ae3b94dfcb10fd1a7c1671595e2ff1855..b6c935736e8c0b8997c3f9a185f382b6258a7166 100644
--- a/src/main/java/net/minecraft/world/entity/animal/horse/SkeletonTrapGoal.java
+++ b/src/main/java/net/minecraft/world/entity/animal/horse/SkeletonTrapGoal.java
@@ -42,7 +42,7 @@ public class SkeletonTrapGoal extends Goal {
 
         if (entitylightning != null) {
             entitylightning.moveTo(this.horse.getX(), this.horse.getY(), this.horse.getZ());
-            entitylightning.setVisualOnly(true);
+            entitylightning.skeletonTrap = true; // Paper
             worldserver.strikeLightning(entitylightning, org.bukkit.event.weather.LightningStrikeEvent.Cause.TRAP); // CraftBukkit
             Skeleton entityskeleton = this.createSkeleton(difficultydamagescaler, this.horse);
 
